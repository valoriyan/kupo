steps:
- id: 'kupo-backend-beta steps'
  name: 'hashicorp/terraform:1.3.5'
  entrypoint: 'sh'
  secretEnv: ['SECURION_PAY_PRIVATE_KEY','DATABASE_URL','WASABI_ACCESS_KEY','WASABI_SECRET_ACCESS_KEY','JWT_PRIVATE_KEY','SENDGRID_API_KEY']
  args:
  - '-c'
  - |
    set -x
    echo "branch $BRANCH_NAME"
    if [ ! -z "$BRANCH_NAME" -a -d "terraform/environments/$BRANCH_NAME/" ]; then
      cd terraform/environments/$BRANCH_NAME
      printf "$$SECURION_PAY_PRIVATE_KEY $$DATABASE_URL $$WASABI_ACCESS_KEY $$WASABI_SECRET_ACCESS_KEY $$JWT_PRIVATE_KEY $$SENDGRID_API_KEY\n" > $BRANCH_NAME.auto.tfvars
      echo "run init"
      terraform init
      echo "run validate"
      terraform validate
      echo "run plan"
      terraform plan -out terraform.plan
      terraform apply -auto-approve terraform.plan
    else
      for dir in terraform/environments/*/
      do
        cd ${dir}
        env=${dir%*/}
        env=${env#*/}
        echo ""
        echo "******************** TERRAFORM PLAN *******************"
        echo "************ Environment: ${env} ************"
        echo "*******************************************************"
        terraform init
        terraform validate
        terraform plan || exit 1
        cd ../../
      done
    fi
availableSecrets:
  secretManager:
  - env: 'SECURION_PAY_PRIVATE_KEY'
    versionName: 'projects/955075264221/secrets/SecPayPrivKey/versions/latest'
  - env: 'DATABASE_URL'
    versionName: 'projects/955075264221/secrets/beta_db_url/versions/latest'
  - env: 'WASABI_ACCESS_KEY'
    versionName: 'projects/955075264221/secrets/beta_wasabi_access_key/versions/latest'
  - env: 'WASABI_SECRET_ACCESS_KEY'
    versionName: 'projects/955075264221/secrets/beta_wasabi-SA-key/versions/latest'
  - env: 'JWT_PRIVATE_KEY'
    versionName: 'projects/955075264221/secrets/beta_jwt_priv_key/versions/latest'
  - env: 'SENDGRID_API_KEY'
    versionName: 'projects/955075264221/secrets/beta_sendgrid_api_key/versions/latest'
